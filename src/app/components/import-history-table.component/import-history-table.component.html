<div class="bulk-btn-container">
  <app-custom-button
    (clicked)="getImportOperations()"
    [disabled]="loading"
    title="Обновить данные"
    class="refresh-button"
  >
    <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960">
      <path
        d="M483.08-200q-117.25 0-198.63-81.34-81.37-81.34-81.37-198.54 0-117.2 81.37-198.66Q365.83-760 483.08-760q71.3 0 133.54 33.88 62.23 33.89 100.3 94.58V-760h40v209.23H547.69v-40h148q-31.23-59.85-87.88-94.54Q551.15-720 483.08-720q-100 0-170 70t-70 170q0 100 70 170t170 70q77 0 139-44t87-116h42.46Q725.08-310.15 651-255.08 576.92-200 483.08-200Z"/>
    </svg>
  </app-custom-button>

  <app-custom-select
    [options]="pageSizeSelectOptions"
    [(ngModel)]="paginationOption.size"
    (ngModelChange)="onPageSizeChange()"
    placeholder="Размер страницы"
    class="page-size-select"
  ></app-custom-select>
</div>

@if (error) {
  <div class="error">{{ error }}</div>
} @else {
  <div class="table_container" [class.loading]="loading">
    <table class="table">
      <colgroup>
        <col style="width: 80px">
        <col style="width: 200px">
        <col style="width: 120px">
        <col style="width: 100px">
        <col style="width: 150px">
        <col style="width: 150px">
        <col style="width: 200px">
        <col style="width: 120px">
      </colgroup>
      <thead>
      <tr>
        @for (header of sortableFields; track header.key) {
          <td [id]="header.key" class="sort_header">{{ header.label }}</td>
        }
      </tr>
      </thead>
      <tbody>
        @if (loading) {
          @for (_ignored of getSkeletonSizeArray(); track i; let i = $index) {
            <tr class="skeleton-row" [style.--delay]="i">
              @for (_ignored of [].constructor(8); track i; let i = $index) {
                <td></td>
              }
            </tr>
          }
        } @else {
          @for (operation of importOperations; track operation.id) {
            <tr>
              <td>{{ operation.id }}</td>
              <td class="filename-cell">{{ operation.filename }}</td>
              <td>
                <span [class]="'status-badge status-' + operation.status.toLowerCase()">
                  {{ getStatusText(operation.status) }}
                </span>
              </td>
              <td>
                @if (operation.createdEntitiesCount !== null && operation.createdEntitiesCount !== undefined) {
                  {{ operation.createdEntitiesCount }}
                } @else {
                  -
                }
              </td>
              <td>{{ operation.startedAt | date: 'dd.MM.yyyy HH:mm' }}</td>
              <td>
                @if (operation.completedAt) {
                  {{ operation.completedAt | date: 'dd.MM.yyyy HH:mm' }}
                } @else {
                  -
                }
              </td>
              <td class="created-by-cell">{{ operation.createdBy }}</td>
              <td>
                @if (operation.errorMessage) {
                  <button
                    class="error-details-btn"
                    (click)="showErrorDetails(operation)"
                    title="Показать детали ошибки"
                  >
                    <svg xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="20px">
                      <path d="M440-280h80v-240h-80v240Zm40-320q17 0 28.5-11.5T520-640q0-17-11.5-28.5T480-680q-17 0-28.5 11.5T440-640q0 17 11.5 28.5T480-600Zm0 520q-83 0-156-31.5T197-197q-54-54-85.5-127T80-480q0-83 31.5-156T197-763q54-54 127-85.5T480-880q83 0 156 31.5T763-763q54 54 85.5 127T880-480q0 83-31.5 156T763-197q-54 54-127 85.5T480-80Zm0-80q134 0 227-93t93-227q0-134-93-227t-227-93q-134 0-227 93t-93 227q0 134 93 227t227 93Zm0-320Z"/>
                    </svg>
                  </button>
                }
              </td>
            </tr>
          }
        }
      </tbody>
    </table>
  </div>

  <div class="pagination-controls">
    <button
      class="pagination-btn"
      (click)="goToPage(0)"
      [disabled]="paginationOption.page === 0">
      <<
    </button>

    <button
      class="pagination-btn"
      (click)="goToPage(paginationOption.page - 1)"
      [disabled]="paginationOption.page === 0">
      <
    </button>

    @for (page of getPageNumbers(); track page) {
      <button
        class="pagination-btn {{ page === paginationOption.page ? 'active' : '' }}"
        (click)="goToPage(page)">
        {{ page + 1 }}
      </button>
    }

    <button
      class="pagination-btn"
      (click)="goToPage(paginationOption.page + 1)"
      [disabled]="paginationOption.page >= totalPages - 1">
      >
    </button>

    <button
      class="pagination-btn"
      (click)="goToPage(totalPages-1)"
      [disabled]="paginationOption.page >= totalPages - 1">
      >>
    </button>
  </div>

  <div class="table_info_container">
    <p>Найдено: {{ totalElements }}, страниц: {{ totalPages }}</p>
    <p>Сортировка: {{ sortOptions.sort }} / {{ sortOptions.direction == 'asc' ? "Возрастание" : "Убывание" }}</p>
  </div>
}

<!-- Модальное окно для деталей ошибки -->
@if (selectedErrorOperation) {
  <div class="modal-overlay" (click)="closeErrorDetails()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>Детали ошибки импорта</h3>
        <button class="close-btn" (click)="closeErrorDetails()">×</button>
      </div>
      <div class="modal-body">
        <div class="error-details">
          <p><strong>Файл:</strong> {{ selectedErrorOperation.filename }}</p>
          <p><strong>Статус:</strong> {{ getStatusText(selectedErrorOperation.status) }}</p>
          <p><strong>Время начала:</strong> {{ selectedErrorOperation.startedAt | date: 'dd.MM.yyyy HH:mm:ss' }}</p>
          @if (selectedErrorOperation.completedAt) {
            <p><strong>Время завершения:</strong> {{ selectedErrorOperation.completedAt | date: 'dd.MM.yyyy HH:mm:ss' }}</p>
          }
          <div class="error-message">
            <strong>Сообщение об ошибке:</strong>
            <pre>{{ selectedErrorOperation.errorMessage }}</pre>
          </div>
        </div>
      </div>
    </div>
  </div>
}
