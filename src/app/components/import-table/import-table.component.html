<p-contextMenu #cm [model]="contextMenuItems"></p-contextMenu>

<app-import-filter #filterComponent (filterChange)="onFilter($event)" [isAdmin]="isCurrentUserAdmin"></app-import-filter>

<div class="flex mt-3 gap-2 align-items-center flex-wrap">
  <p-button
    (onClick)="loadImportOperations()"
    [disabled]="loading"
    [outlined]="true"
    icon="pi pi-refresh"
  />

  <p-button
    [disabled]="isFilterEmpty"
    [outlined]="true"
    icon="pi pi-filter-slash"
    severity="secondary"
    label="Очистить фильтр"
    (click)="onFilterClear()"
    [severity]="isFilterEmpty ? 'secondary' : 'info'"
  />
</div>

<p-panel showHeader="false" class="mt-3">
  <p-table
    (onSort)="customSort($event)"
    [breakpoint]="'768px'"
    [lazy]="true"
    [loading]="loading"
    [value]="imports"
    [customSort]="true"
    class="mt-2 table"
    dataKey="id"
    [rowTrackBy]="trackByFn"
  >
    <ng-template #header>
      <tr>
        <th [pSortableColumnDisabled]="loading || !imports.length" pSortableColumn="id" style="width: 3rem; border-top-left-radius: 5px">
          <div class="flex items-center gap-2">
            ID
            <p-sortIcon field="id"/>
          </div>
        </th>
        <th [pSortableColumnDisabled]="loading || !imports.length" pSortableColumn="filename" style="width: 10rem">
          <div class="flex items-center gap-2">
            Имя файла
            <p-sortIcon field="filename"/>
          </div>
        </th>
        <th [pSortableColumnDisabled]="loading || !imports.length" pSortableColumn="status" style="width: 9rem">
          <div class="flex items-center gap-2">
            Статус
            <p-sortIcon field="status"/>
          </div>
        </th>
        <th [pSortableColumnDisabled]="loading || !imports.length" pSortableColumn="createdEntitiesCount" style="width: 6rem">
          <div class="flex items-center gap-2">
            Создано
            <p-sortIcon field="createdEntitiesCount"/>
          </div>
        </th>
        <th [pSortableColumnDisabled]="loading || !imports.length" pSortableColumn="errorMessage" style="width: 22rem">
          <div class="flex items-center gap-2">
            Описание ошибки
            <p-sortIcon field="errorMessage"/>
          </div>
        </th>
        <th [pSortableColumnDisabled]="loading || !imports.length" pSortableColumn="startedAt" style="width: 9rem">
          <div class="flex items-center gap-2">
            Начат
            <p-sortIcon field="startedAt"/>
          </div>
        </th>
        <th [pSortableColumnDisabled]="loading || !imports.length" pSortableColumn="completedAt" style="width: 9rem">
          <div class="flex items-center gap-2">
            Завершен
            <p-sortIcon field="completedAt"/>
          </div>
        </th>
        <th [pSortableColumnDisabled]="loading || !imports.length" pSortableColumn="user.username" style="width: 8rem">
          <div class="flex items-center gap-2">
            Создал пользователь
            <p-sortIcon field="user.username"/>
          </div>
        </th>
        <th style="width: 3rem">
          <div class="flex items-center gap-2">
            Действия
          </div>
        </th>
      </tr>
    </ng-template>

    <ng-template #body let-imp>
      <tr [class]="rowClass(imp)" (contextmenu)="onRowRightClick(imp, $event)">
        <td>{{ imp.id }}</td>
        <td class="truncate-cell" [pTooltip]="imp.filename">{{ imp.filename }}</td>
        <td>
          <span class="status-badge" [class]="'status-' + imp.status.toLowerCase()">
            {{ imp.status }}
          </span>
        </td>
        <td>{{ imp.createdEntitiesCount ?? '—' }}</td>
        <td class="truncate-cell" [pTooltip]="imp.errorMessage || ''">
          {{ (imp.errorMessage || '—') | slice:0:40 }}{{ imp.errorMessage && imp.errorMessage.length > 40 ? '...' : '' }}
        </td>
        <td>{{ imp.startedAt ? formatDate(imp.startedAt) + ' ' + formatTime(imp.startedAt) : '—' }}</td>
        <td>{{ imp.completedAt ? formatDate(imp.completedAt) + ' ' + formatTime(imp.completedAt) : '—' }}</td>
        <td>{{ imp.createdBy }}</td>
        <td>
          <div class="flex gap-1">
            <p-button
              (onClick)="downloadImportFile(imp)"
              icon="pi pi-download"
              outlined
              severity="secondary"
              size="small"
              [disabled]="loading || !canDownload(imp)"
            />
          </div>
        </td>
      </tr>
    </ng-template>

    <ng-template #emptymessage>
      <tr>
        <td colspan="9">
          {{ generalError || 'Список импортов пуст' }}
        </td>
      </tr>
    </ng-template>
  </p-table>
</p-panel>

<app-paginator
  [page]="pageableRequest.page"
  [size]="pageableRequest.size"
  [totalRecords]="totalRecords"
  (pageChange)="onPageChange($event)"
></app-paginator>
