<div [style.display]="filtersOpen ? 'grid' : 'none'" class="filters_container">

  <app-input
    (onChange)="applyFilters()"
    [(value)]="filterOptions.username"
    label="Имя пользователя"
    placeholder="Имя пользователя"
  >
  </app-input>

  <app-input
    (onChange)="applyFilters()"
    [(value)]="filterOptions.createdAt"
    label="Дата создания от"
    placeholder="дд.мм.гггг"
    type="date"
  >
  </app-input>

  <app-input
    (onChange)="applyFilters()"
    [(value)]="filterOptions.updatedAt"
    label="Дата обновления от"
    placeholder="дд.мм.гггг"
    type="date"
  >
  </app-input>
</div>

<div class="bulk-btn-container">
  <app-custom-button
    (clicked)="getUsers()"
    [disabled]="loading"
    class="refresh-button"
    title="Обновить данные"
  >
    <svg class="icon" viewBox="0 -960 960 960" xmlns="http://www.w3.org/2000/svg">
      <path
        d="M483.08-200q-117.25 0-198.63-81.34-81.37-81.34-81.37-198.54 0-117.2 81.37-198.66Q365.83-760 483.08-760q71.3 0 133.54 33.88 62.23 33.89 100.3 94.58V-760h40v209.23H547.69v-40h148q-31.23-59.85-87.88-94.54Q551.15-720 483.08-720q-100 0-170 70t-70 170q0 100 70 170t170 70q77 0 139-44t87-116h42.46Q725.08-310.15 651-255.08 576.92-200 483.08-200Z"/>
    </svg>
  </app-custom-button>

  <app-custom-select
    (ngModelChange)="onPageSizeChange()"
    [(ngModel)]="paginationOption.size"
    [options]="pageSizeSelectOptions"
    class="page-size-select"
    placeholder="Размер страницы"
  ></app-custom-select>

  @if (filtersToggle) {
    <app-custom-button
      (clicked)="toggleFiltersOpen()"
      [disabled]="!filtersToggle">
      {{ filtersOpen ? 'Скрыть фильтры' : 'Показать фильтры' }}
    </app-custom-button>
  }

  <app-custom-button
    (clicked)="resetFilters()"
    [disabled]="isFiltersClear()">
    Сбросить фильтры
  </app-custom-button>

  <app-custom-button
    (clicked)="deleteSelectedUsers()"
    [disabled]="getSelectedCount() === 0"
    [title]="getSelectedCount() === 0 ? 'Нет выбранных пользователей для удаления' : 'Удалить выбранных пользователей'"
    variant="danger"
  >
    Удалить выбранных ({{ getSelectedCount() }})
  </app-custom-button>
</div>

@if (error) {
  <div class="error">{{ error }}</div>
} @else {
  <div [class.loading]="loading" class="table_container">
    <table class="table">
      <colgroup>
        <col style="width: 40px">
        <col style="width: 80px">
        <col style="width: 200px">
        <col style="width: 300px">
        <col style="width: 150px">
        <col style="width: 150px">
        <col style="width: 120px">
      </colgroup>
      <thead>
      <tr>
        <td class="checkbox-column">
          <label class="checkbox-label">
            <input
              (change)="toggleSelectAll()"
              [checked]="isAllSelected"
              type="checkbox">
            <span class="checkmark"></span>
          </label>
        </td>
        @for (header of sortableFields; track header.key) {
          <td (click)="setSorting(header.key)" [id]="header.key" [style.--afterVal]="getSortAfter(header.key)" class="sort_header">{{ header.label }}</td>
        }
        <td>Действия</td>
      </tr>
      </thead>
      <tbody>
        @if (loading) {
          @for (_ignored of getSkeletonSizeArray(); track i; let i = $index) {
            <tr [style.--delay]="i" class="skeleton-row">
              @for (_ignored of [].constructor(8); track i; let i = $index) {
                <td></td>
              }
            </tr>
          }
        } @else {
          @for (user of users; track user.id) {
            <tr [class.selected]="isUserSelected(user.id)">
              <td class="checkbox-column">
                <label class="checkbox-label">
                  <input
                    (change)="toggleUserSelection(user.id)"
                    [checked]="isUserSelected(user.id)"
                    type="checkbox">
                  <span class="checkmark"></span>
                </label>
              </td>
              <td>{{ user.id }}</td>
              <td>{{ user.username }}</td>
              <td>
                <div class="roles-container">
                  @for (role of user.roles; let i = $index; track i) {
                    <span class="role-badge">{{ role.toString() }}</span>
                  }
                </div>
              </td>
              <td>{{ user.createdAt | date: 'dd.MM.yyyy HH:mm' }}</td>
              <td>{{ user.updatedAt | date: 'dd.MM.yyyy HH:mm' }}</td>
              <td>
                <div class="buttons_container">
                  <button
                    (click)="openEditModal(user.id)"
                    class="edit-btn"
                    title="Редактировать пользователя">
                    <svg height="20px" viewBox="0 -960 960 960" width="20px" xmlns="http://www.w3.org/2000/svg">
                      <path
                        d="M200-200h43.92l427.93-427.92-43.93-43.93L200-243.92V-200Zm-40 40v-100.77l527.23-527.77q6.15-5.48 13.57-8.47 7.43-2.99 15.49-2.99t15.62 2.54q7.55 2.54 13.94 9.15l42.69 42.93q6.61 6.38 9.04 14 2.42 7.63 2.42 15.25 0 8.13-2.74 15.56-2.74 7.42-8.72 13.57L260.77-160H160Zm600.77-556.31-44.46-44.46 44.46 44.46ZM649.5-649.5l-21.58-22.35 43.93 43.93-22.35-21.58Z"/>
                    </svg>
                  </button>
                  <button
                    (click)="deleteUser(user.id, $event)"
                    class="delete-button"
                    title="Удалить пользователя">
                    <svg height="20px" viewBox="0 -960 960 960" width="20px" xmlns="http://www.w3.org/2000/svg">
                      <path
                        d="M304.62-160q-26.85 0-45.74-18.88Q240-197.77 240-224.62V-720h-40v-40h160v-30.77h240V-760h160v40h-40v495.38q0 27.62-18.5 46.12Q683-160 655.38-160H304.62ZM680-720H280v495.38q0 10.77 6.92 17.7 6.93 6.92 17.7 6.92h350.76q9.24 0 16.93-7.69 7.69-7.69 7.69-16.93V-720ZM392.31-280h40v-360h-40v360Zm135.38 0h40v-360h-40v360ZM280-720v520-520Z"/>
                    </svg>
                  </button>
                </div>
              </td>
            </tr>
          }
        }
      </tbody>
    </table>
  </div>

  <div class="pagination-controls">
    <button
      (click)="goToPage(0)"
      [disabled]="paginationOption.page === 0"
      class="pagination-btn">
      <<
    </button>

    <button
      (click)="goToPage(paginationOption.page - 1)"
      [disabled]="paginationOption.page === 0"
      class="pagination-btn">
      <
    </button>

    @for (page of getPageNumbers(); track page) {
      <button
        (click)="goToPage(page)"
        class="pagination-btn {{ page === paginationOption.page ? 'active' : '' }}">
        {{ page + 1 }}
      </button>
    }

    <button
      (click)="goToPage(paginationOption.page + 1)"
      [disabled]="paginationOption.page >= totalPages - 1"
      class="pagination-btn">
      >
    </button>

    <button
      (click)="goToPage(totalPages-1)"
      [disabled]="paginationOption.page >= totalPages - 1"
      class="pagination-btn">
      >>
    </button>
  </div>

  <div class="table_info_container">
    <p>Найдено: {{ totalElements }}, страниц: {{ totalPages }}</p>
    <p>Сортировка: {{ sortOptions.sort }} / {{ sortOptions.direction == 'asc' ? "Возрастание" : "Убывание" }}</p>
  </div>
}
