<div class="wrapper">
  @if (isSelectMode) {
    <div class="selector-section">
      <div class="section-header">
        <h4>Выбор персоны</h4>
        <button
          type="button"
          class="btn btn-primary"
          (click)="switchMode('create')"
          [disabled]="isLoading()">
          Создать новую
        </button>
      </div>

      @if (selectedPerson()) {
        <div class="selected-item">
          <div class="selected-info">
            {{ selectedPerson()!.displayName }}
          </div>
          <button
            type="button"
            class="btn-clear"
            (click)="clearSelection()">
            ✕
          </button>
        </div>
      } @else {
        <div class="selector-container">
          @if (isLoading()) {
            <div class="loading">Загрузка персон...</div>
          } @else if (personOptions.length === 0) {
            <div class="empty-state">
              Нет доступных персон
            </div>
          } @else {
            <app-custom-select
              [options]="personOptions"
              [placeholder]="'Выберите персону'"
              [label]="''"
              [searchable]="true"
              (selectedChange)="onPersonSelect($event)">
            </app-custom-select>
          }
        </div>
      }
    </div>
  }

  <!-- Режим создания -->
  @if (isCreateMode) {
    <div class="creation-section">
      <div class="section-header">
        <h4>Создание персоны</h4>
        <button
          type="button"
          class="btn btn-primary"
          (click)="switchMode('select')"
          [disabled]="isLoading()">
          выбор
        </button>
      </div>

      <form [formGroup]="personForm" class="creation-form">
        <div class="form-row">
          <div class="form-group">
            <label for="person-name" class="label">Имя *</label>
            <input
              id="person-name"
              type="text"
              formControlName="name"
              class="input"
              [class.error]="hasFieldError('name')"
              placeholder="Введите имя">
            <div class="error-container" [class.show]="hasFieldError('name')">
              <div class="error-message">{{ getFieldError('name') }}</div>
            </div>
          </div>

          <div class="form-group">
            <label for="person-weight" class="label">Вес (кг) *</label>
            <input
              id="person-weight"
              type="number"
              formControlName="weight"
              class="input"
              [class.error]="hasFieldError('weight')"
              placeholder="Введите вес"
              step="0.1"
              min="0.1">
            <div class="error-container" [class.show]="hasFieldError('weight')">
              <div class="error-message">{{ getFieldError('weight') }}</div>
            </div>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label class="label">Цвет глаз *</label>
            <app-custom-select
              formControlName="eyeColor"
              [options]="eyeColorOptions"
              [placeholder]="'Выберите цвет глаз'"
              [label]="''"
              [required]="true">
            </app-custom-select>
            <div class="error-container" [class.show]="hasFieldError('eyeColor')">
              <div class="error-message">{{ getFieldError('eyeColor') }}</div>
            </div>
          </div>

          <div class="form-group">
            <label class="label">Цвет волос *</label>
            <app-custom-select
              formControlName="hairColor"
              [options]="hairColorOptions"
              [placeholder]="'Выберите цвет волос'"
              [label]="''"
              [required]="true">
            </app-custom-select>
            <div class="error-container" [class.show]="hasFieldError('hairColor')">
              <div class="error-message">{{ getFieldError('hairColor') }}</div>
            </div>
          </div>

          <div class="form-group">
            <label class="label">Национальность *</label>
            <app-custom-select
              formControlName="nationality"
              [options]="nationalityOptions"
              [placeholder]="'Выберите страну'"
              [label]="''"
              [required]="true">
            </app-custom-select>
            <div class="error-container" [class.show]="hasFieldError('nationality')">
              <div class="error-message">{{ getFieldError('nationality') }}</div>
            </div>
          </div>
        </div>

        <div class="nested-section">
          <label class="label">Локация *</label>
          <app-location-selector
            (locationSelected)="onLocationSelected($event)">
          </app-location-selector>
            <div class="error-container" [class.show]="!locationId() && (personForm.touched || personForm.dirty)">
              <div class="error-message">Необходимо выбрать локацию</div>
            </div>
        </div>

        @if (errorMessage()) {
          <div class="global-error">
            {{ errorMessage() }}
          </div>
        }

        <div class="form-actions">
          <button
            type="button"
            class="btn btn-secondary"
            (click)="switchMode('select')"
            [disabled]="isLoading()">
            Отмена
          </button>
          <button
            type="button"
            class="btn btn-primary"
            (click)="createPerson()"
            [disabled]="!isFormValid || isLoading()">
            @if (isLoading()) {
              Создание...
            } @else {
              Создать персону
            }
          </button>
        </div>
      </form>
    </div>
  }
</div>
